# 機能仕様書

## 1. 機能一覧

| 機能 | 対象ユーザー | 画面 |
|------|-------------|------|
| ログイン | 社内メンバー | `/login` |
| チーム作成・参加 | 社内メンバー | `/team` |
| ダッシュボード | 社内メンバー | `/dashboard` |
| 予約メニュー管理 | 社内メンバー | `/event-types` |
| 予約一覧 | 社内メンバー | `/bookings` |
| メンバー管理 | 社内メンバー | `/members` |
| 予約可能時間設定 | 社内メンバー | `/settings` |
| 管理画面 | 管理者 | `/admin` |
| 予約ページ | 外部ユーザー | `/book/{slug}` |
| キャンセル | 外部ユーザー | `/cancel/{token}` |

---

## 2. 認証機能

### 2.1 ログイン

**URL**: `/login`

**機能概要**:
- Googleアカウントでログイン
- 初回ログイン時にメンバーとして自動登録
- Googleカレンダーへのアクセス権限を取得

**処理フロー**:
1. 「Googleでログイン」ボタンをクリック
2. Google OAuth同意画面にリダイレクト
3. 権限を承認
4. コールバック処理でメンバー登録/更新
5. チーム所属がある場合 → ダッシュボード
6. チーム所属がない場合 → チーム画面

**取得スコープ**:
- `calendar.readonly` - カレンダー参照
- `calendar.events` - イベント作成・削除

### 2.2 ログアウト

**URL**: `/api/auth/logout`

**機能概要**:
- セッションCookieを削除
- ログインページにリダイレクト

---

## 3. チーム機能

### 3.1 チーム作成

**URL**: `/team`

**機能概要**:
- 新しいチームを作成
- 8文字の招待コードを自動生成

**入力項目**:
| 項目 | 必須 | バリデーション |
|------|------|---------------|
| チーム名 | 必須 | 1文字以上 |

**出力**:
- 招待コード（例: `AB3D5F7H`）

### 3.2 チーム参加

**URL**: `/team`

**機能概要**:
- 招待コードでチームに参加

**入力項目**:
| 項目 | 必須 | バリデーション |
|------|------|---------------|
| 招待コード | 必須 | 8文字 |

**エラー**:
- 無効な招待コード
- 既に別チームに所属

---

## 4. 予約メニュー管理

### 4.1 一覧表示

**URL**: `/event-types`

**表示項目**:
- タイトル
- 所要時間
- 予約ページURL
- 有効/無効ステータス

**操作**:
- 新規作成
- 編集
- リンクコピー
- 予約ページを開く

### 4.2 新規作成

**URL**: `/event-types/new`

**入力項目**:
| 項目 | 必須 | バリデーション | デフォルト |
|------|------|---------------|-----------|
| タイトル | 必須 | 1文字以上 | - |
| 説明 | 任意 | - | - |
| 所要時間 | 必須 | 15/30/45/60分 | 30分 |
| 参加メンバー | 任意 | チーム内メンバー | 作成者のみ |

**処理**:
- スラッグを自動生成（UUID）
- 作成者を主催者として設定

### 4.3 編集

**URL**: `/event-types/{id}`

**編集可能項目**:
- タイトル
- 説明
- 所要時間
- 参加メンバー

**制約**:
- スラッグは変更不可
- 同一チームのメンバーのみ編集可能

### 4.4 削除

**処理**:
- 予約メニューを非アクティブ化
- 関連する予約は維持（履歴として）

---

## 5. 予約ページ

### 5.1 空き枠表示

**URL**: `/book/{slug}`

**機能概要**:
- 日付選択カレンダーを表示
- 選択した日付の空き枠を表示
- 全参加メンバーの空き時間をマージ

**表示要素**:
- 予約メニュー情報（タイトル、説明、所要時間）
- 日付選択カレンダー（今日〜2週間）
- 時間枠一覧

**空き枠計算ロジック**:
1. 参加メンバー全員のGoogleカレンダーを取得
2. 予約済み時間を除外
3. 予約可能時間設定（曜日・時間）でフィルタ
4. 所要時間単位でスロット化

### 5.2 予約フォーム

**入力項目**:
| 項目 | 必須 | バリデーション |
|------|------|---------------|
| お名前 | 必須 | 1文字以上 |
| メールアドレス | 必須 | メール形式 |
| ご相談内容・備考 | 必須 | 1文字以上 |

### 5.3 予約確定

**処理フロー**:
1. 空き状況を再確認（競合防止）
2. Googleカレンダーにイベント作成
3. Google Meetリンクを自動生成
4. 予約データをDBに保存
5. キャンセルトークンを生成

**確定画面の表示**:
- 予約日時
- Google Meetリンク
- キャンセルURL

**Googleカレンダーイベント**:
- タイトル: `{予約メニュー名} - {予約者名}`
- 参加者: 全メンバー + 予約者
- Google Meet: 自動付与
- 説明: 備考を含む

---

## 6. キャンセル機能

### 6.1 キャンセルページ

**URL**: `/cancel/{token}?bookingId={id}`

**表示内容**:
- 予約詳細（日時、予約メニュー名）
- キャンセル確認ボタン

**制約**:
- 過去の予約はキャンセル不可
- 既にキャンセル済みの場合はエラー

### 6.2 キャンセル処理

**処理フロー**:
1. トークンの検証
2. Googleカレンダーのイベント削除
3. 予約ステータスを「キャンセル」に更新
4. キャンセルトークンを無効化

---

## 7. 予約可能時間設定

### 7.1 曜日別設定

**URL**: `/settings`

**設定項目（曜日ごと）**:
| 項目 | 説明 |
|------|------|
| 有効/無効 | その曜日に予約を受け付けるか |
| 開始時間 | 予約受付開始時間（30分刻み） |
| 終了時間 | 予約受付終了時間（30分刻み） |

**デフォルト値**:
- 月〜金: 有効（09:00〜18:00）
- 土・日: 無効

---

## 8. 予約一覧

### 8.1 一覧表示

**URL**: `/bookings`

**フィルター**:
- 今後の予約
- 過去の予約
- すべて

**表示項目**:
- 予約者名
- 予約者メールアドレス
- 日時
- 予約メニュー名
- ステータス（確定/キャンセル）
- 備考

---

## 9. メンバー管理

### 9.1 一覧表示

**URL**: `/members`

**表示項目**:
- 名前
- メールアドレス
- カレンダー連携状況
- 有効/無効ステータス

### 9.2 ステータス変更

**機能概要**:
- メンバーの有効/無効を切り替え
- 無効化したメンバーは空き枠計算から除外

---

## 10. 管理画面

### 10.1 システムステータス

**URL**: `/admin`

**表示項目**:
- メンテナンスモード状態
- API利用量（今月）

### 10.2 メンテナンスモード

**機能概要**:
- 有効化すると外部ユーザーからの予約を停止
- 社内メンバーは引き続きアクセス可能

### 10.3 API利用量

**表示項目**:
- 総リクエスト数
- 空き枠確認回数
- 予約作成回数
- キャンセル回数

---

## 11. API仕様

### 11.1 空き枠取得

**エンドポイント**: `GET /api/availability`

**パラメータ**:
| 名前 | 型 | 必須 | 説明 |
|------|-----|------|------|
| eventTypeId | UUID | 必須 | 予約メニューID |
| date | YYYY-MM-DD | 必須 | 対象日 |

**レスポンス**:
```json
{
  "slots": [
    { "start": "2024-01-15T09:00:00+09:00", "end": "2024-01-15T09:30:00+09:00" },
    { "start": "2024-01-15T10:00:00+09:00", "end": "2024-01-15T10:30:00+09:00" }
  ],
  "timezone": "Asia/Tokyo"
}
```

### 11.2 予約作成

**エンドポイント**: `POST /api/bookings`

**リクエスト**:
```json
{
  "eventTypeId": "uuid",
  "startAt": "2024-01-15T09:00:00+09:00",
  "endAt": "2024-01-15T09:30:00+09:00",
  "name": "山田太郎",
  "email": "yamada@example.com",
  "note": "ご相談内容"
}
```

**レスポンス**:
```json
{
  "success": true,
  "booking": { "id": "uuid", "startAt": "...", "endAt": "..." },
  "cancelUrl": "https://example.com/cancel/xxx?bookingId=yyy",
  "meetLink": "https://meet.google.com/xxx"
}
```

### 11.3 キャンセル

**エンドポイント**: `POST /api/bookings/cancel`

**リクエスト**:
```json
{
  "bookingId": "uuid",
  "token": "cancel-token"
}
```

**レスポンス**:
```json
{
  "success": true,
  "message": "予約がキャンセルされました。"
}
```
