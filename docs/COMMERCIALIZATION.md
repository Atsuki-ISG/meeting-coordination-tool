# 商用化に向けた改善項目一覧

## 概要
MeetFlow（日程調整ツール）を有料サービスとして運用するために必要な改善項目を洗い出した。

---

## 1. 決済周り

### 必要な実装
- [ ] 料金プラン設計（Free / Pro / Enterprise など）
- [ ] Stripe または PAY.JP 連携
- [ ] サブスクリプション管理（作成・更新・キャンセル）
- [ ] 請求書発行機能
- [ ] 支払い履歴表示
- [ ] トライアル期間管理
- [ ] プランごとの機能制限（メンバー数、予約数など）
- [ ] 未払い時のアカウント制限処理
- [ ] 返金処理フロー

---

## 2. 規約周り

### 必要なドキュメント
- [ ] 利用規約（Terms of Service）
- [ ] プライバシーポリシー
- [ ] Cookieポリシー
- [ ] 特定商取引法に基づく表記
- [ ] 返金ポリシー
- [ ] SLA（サービスレベル契約）

### システム対応
- [ ] 規約同意チェックボックス（初回ログイン時）
- [ ] 同意履歴の記録（誰がいつ何に同意したか）
- [ ] 規約更新時の再同意フロー
- [ ] Cookie同意バナー

---

## 3. セキュリティ関連

### 🔴 Critical（即修正必須）
- [ ] **フォールバック秘密鍵の削除** - middleware.ts, session.ts の `'fallback-secret-key-for-development'` を削除
- [ ] **ENCRYPTION_KEY の検証** - 起動時に形式・長さをチェック
- [ ] **ログの個人情報除去** - console.error から member.id, token 情報を除外
- [ ] **入力値サニタイズ** - note, description, title の最大長制限、HTMLタグ検出

### ⚠️ High（早期改善推奨）
- [ ] **セキュリティヘッダー追加**
  - Content-Security-Policy
  - X-Content-Type-Options
  - X-Frame-Options
  - Strict-Transport-Security
- [ ] **エラー詳細の制御** - 本番環境でZodエラー詳細を隠す
- [ ] **IP スプーフィング対策** - X-Forwarded-For の安全な処理
- [ ] **暗号化キーの固定ソルト問題** - 環境ごとに異なるソルトを使用

### 📋 Medium（中期改善）
- [ ] 監査ログの整備（認証イベント、重要操作）
- [ ] セッション有効期限の見直し（現在7日間）
- [ ] CSRF トークンの明示的実装
- [ ] 2要素認証（2FA）の検討

---

## 4. 不正防止関連

### レート制限の強化
- [ ] **分散レート制限** - インメモリからRedisに移行（複数インスタンス対応）
- [ ] エンドポイント別のレート制限設定
- [ ] ユーザー単位のレート制限
- [ ] ブルートフォース攻撃対策（ログイン試行制限）

### 不正利用検知
- [ ] 異常なアクセスパターン検出
- [ ] 同一IPからの大量アカウント作成防止
- [ ] 予約スパム防止（CAPTCHA検討）
- [ ] 不正なキャンセルトークン試行の検出

### アカウント管理
- [ ] アカウントロック機能
- [ ] 不正アカウントの一括停止機能
- [ ] IPブロックリスト管理

---

## 5. 監視の強化

### ヘルスチェック
- [ ] `/api/health` エンドポイント実装
  - Supabase接続確認
  - Google OAuth接続確認
  - レスポンス形式: `{ status, timestamp, details }`
- [ ] ロードバランサー用ヘルスチェック

### APM（アプリケーションパフォーマンス監視）
- [ ] DataDog / New Relic / Elastic APM 導入
- [ ] エンドポイント別レスポンスタイム計測
- [ ] P95, P99 レイテンシー監視
- [ ] エラー率監視

### アラート
- [ ] エラー率閾値アラート
- [ ] レスポンスタイム閾値アラート
- [ ] API使用量アラート（80%, 100%）
- [ ] サービスダウン検知

### ログ収集
- [ ] **構造化ロギング導入**（Winston / Pino）
- [ ] ログレベル区分（DEBUG, INFO, WARN, ERROR）
- [ ] リクエストID付与（トレーサビリティ）
- [ ] ログ集約サービス連携（Cloud Logging等）

---

## 6. プライバシー・GDPR対応

### 🔴 必須対応
- [ ] **アカウント削除機能** - ユーザーが自身のデータを削除できる（GDPR第17条）
- [ ] **データエクスポート機能** - JSON形式でのダウンロード（GDPR第20条）
- [ ] **予約者情報の暗号化** - requester_name, requester_email, note を暗号化
- [ ] **Google Token Revoke** - ログアウト/削除時にGoogleへrevoke送信

### データ保持ポリシー
- [ ] 保持期間の定義とCronによる自動削除
  - キャンセル済み予約: 1年
  - API使用ログ: 90日
  - システムログ: 30日
- [ ] 削除監査ログの記録

---

## 7. マルチテナント分離強化

### データベース
- [ ] **bookings テーブルに team_id 追加**
- [ ] **api_usage_logs テーブルに team_id 追加**
- [ ] **RLSポリシー強化** - team_id ベースのアクセス制御

### API レベル
- [ ] イベントタイプのテナント検証強化
- [ ] 他テナントのリソースへのアクセス防止

---

## 8. インフラ・スケーラビリティ

### キャッシュ戦略
- [ ] Redis導入
- [ ] イベントタイプ情報キャッシュ（300秒）
- [ ] メンバー情報キャッシュ（600秒）
- [ ] キャッシュ無効化ロジック

### データベース最適化
- [ ] 複合インデックス追加
  - `idx_bookings_event_type_status_start`
  - `idx_api_usage_logs_created_endpoint`
- [ ] N+1クエリ問題の解消
- [ ] クエリ実行計画の確認

### 非同期処理
- [ ] ジョブキュー導入（BullMQ / Inngest）
- [ ] 重い処理のバックグラウンド実行
- [ ] リトライロジック（exponential backoff）
- [ ] デッドレターキュー

---

## 9. 障害復旧・運用

### バックアップ
- [ ] Supabaseバックアップ設定の文書化
- [ ] RPO（復旧ポイント目標）定義: 24時間以内
- [ ] RTO（復旧時間目標）定義: 1時間以内
- [ ] 定期的な復旧テスト実施

### 障害対応
- [ ] インシデント対応手順書
- [ ] エスカレーションフロー
- [ ] 個人情報漏洩時の対応計画
- [ ] 関係当局への通知テンプレート

### デプロイ
- [ ] ロールバック手順
- [ ] ブルーグリーンデプロイ検討
- [ ] マイグレーション失敗時の対応

---

## 10. サポート体制

- [ ] お問い合わせフォーム
- [ ] FAQ / ヘルプセンター
- [ ] サポートチケットシステム
- [ ] 障害情報ステータスページ

---

## 11. テスト・品質保証

- [ ] ユニットテスト整備
- [ ] E2Eテスト（Playwright / Cypress）
- [ ] 負荷テスト（k6 / Artillery）
- [ ] セキュリティテスト（OWASP ZAP）

---

## 12. その他の検討事項

### 多言語対応
- [ ] i18n対応（日本語 + 英語）
- [ ] タイムゾーン対応の強化

### アクセシビリティ
- [ ] WCAG 2.1 AA準拠
- [ ] キーボードナビゲーション
- [ ] スクリーンリーダー対応

### 分析・マーケティング
- [ ] Google Analytics / Mixpanel 導入
- [ ] コンバージョントラッキング
- [ ] A/Bテスト基盤

---

## 優先度別まとめ

### Phase 1: 商用化前に必須（1-2ヶ月）
1. セキュリティ Critical 項目すべて
2. 利用規約・プライバシーポリシー
3. 決済基盤（最低限のプラン）
4. アカウント削除機能
5. ヘルスチェック実装
6. 構造化ロギング

### Phase 2: 商用化直後（2-4ヶ月）
1. セキュリティ High 項目
2. 分散レート制限（Redis）
3. APM導入
4. マルチテナント分離強化
5. データエクスポート機能
6. サポート体制整備

### Phase 3: 成長期（4-6ヶ月）
1. キャッシュ戦略
2. 非同期ジョブキュー
3. テスト自動化
4. 多言語対応
5. 高度な分析機能

---

## 関連ファイル（セキュリティ関連）
- `/src/middleware.ts` - フォールバック秘密鍵
- `/src/lib/auth/session.ts` - フォールバック秘密鍵
- `/src/lib/utils/encryption.ts` - 暗号化実装
- `/src/lib/rate-limit/index.ts` - レート制限
- `/src/app/api/bookings/route.ts` - 入力バリデーション
- `/supabase/migrations/*.sql` - RLSポリシー
