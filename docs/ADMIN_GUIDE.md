# 運用マニュアル

## 1. 日常運用

### 1.1 監視項目

| 項目 | 確認頻度 | 確認方法 |
|------|---------|---------|
| API利用量 | 週1回 | `/admin` 画面 |
| 予約状況 | 日次 | `/bookings` 画面 |
| エラーログ | 日次 | Vercel Dashboard |
| メンバー状況 | 週1回 | `/members` 画面 |

### 1.2 API利用量の目安

Google Calendar API の無料枠:
- **日次上限**: 1,000,000 クエリ/日
- **ユーザーあたり上限**: 10,000 クエリ/日

**想定利用量（5人チーム）**:
| 操作 | APIコール数 | 月間想定回数 | 月間コール数 |
|------|------------|------------|-------------|
| 空き枠確認 | 5回/日付 | 1,000 | 5,000 |
| 予約作成 | 6回 | 100 | 600 |
| キャンセル | 1回 | 20 | 20 |
| **合計** | | | **約5,600** |

→ 無料枠内で十分運用可能

---

## 2. メンテナンス

### 2.1 メンテナンスモードの有効化

予約受付を一時停止する場合：

1. `/admin` にアクセス
2. 「Stop Service」ボタンをクリック
3. 外部ユーザーの予約ページに停止メッセージが表示される

**影響範囲**:
- `/book/*` ページで予約不可
- 社内メンバーの管理機能は利用可能

### 2.2 メンテナンスモードの解除

1. `/admin` にアクセス
2. 「Enable Service」ボタンをクリック

---

## 3. トラブルシューティング

### 3.1 ログインできない

**症状**: Googleログインボタンを押してもエラーになる

**確認手順**:
1. Google Cloud Console でOAuthクライアントIDを確認
2. リダイレクトURIが正しいか確認
3. OAuth同意画面が「本番環境」になっているか確認

**解決策**:
- リダイレクトURIを追加: `https://your-domain.com/api/auth/callback`
- OAuth同意画面を本番公開

### 3.2 カレンダー連携ができない

**症状**: ログインはできるがカレンダーが連携されない

**確認手順**:
1. Google OAuth同意画面でスコープを確認
2. Calendar API が有効か確認

**解決策**:
- スコープに `calendar.readonly`, `calendar.events` を追加
- ユーザーに再ログインを依頼

### 3.3 空き枠が表示されない

**症状**: 予約ページで空き枠が出てこない

**確認手順**:
1. `/members` で対象メンバーが有効か確認
2. `/settings` で予約可能時間が設定されているか確認
3. メンバーのカレンダー連携状況を確認

**解決策**:
- メンバーを有効化
- 予約可能時間を設定
- メンバーに再ログインを依頼してカレンダーを再連携

### 3.4 予約が作成できない

**症状**: 予約ボタンを押してもエラーになる

**確認手順**:
1. `/admin` でメンテナンスモードを確認
2. ブラウザの開発者ツールでエラー内容を確認

**よくあるエラー**:
- `Selected time slot is no longer available`: 他の予約と競合
- `No members with calendar access`: メンバーのカレンダー連携切れ

### 3.5 Google Meetリンクが生成されない

**症状**: 予約は作成されるがMeetリンクがない

**原因**: Googleカレンダーのイベント作成権限の問題

**解決策**:
- 主催者のGoogle Workspaceアカウント設定を確認
- 個人アカウントの場合、Meetの自動生成が制限される場合あり

---

## 4. データ管理

### 4.1 バックアップ

Supabaseの自動バックアップ:
- **頻度**: 日次
- **保持期間**: 7日間（無料プラン）

手動バックアップ:
1. Supabase Dashboard → Database → Backups
2. 「Create backup」をクリック

### 4.2 データ削除

**古い予約データの削除**:

Supabase SQL Editor で実行:
```sql
-- 1年以上前のキャンセル済み予約を削除
DELETE FROM bookings
WHERE status = 'canceled'
  AND canceled_at < NOW() - INTERVAL '1 year';
```

**APIログの削除**:
```sql
-- 3ヶ月以上前のログを削除
DELETE FROM api_usage_logs
WHERE created_at < NOW() - INTERVAL '3 months';
```

---

## 5. セキュリティ運用

### 5.1 定期的な確認項目

| 項目 | 頻度 | 確認方法 |
|------|------|---------|
| メンバー一覧 | 月1回 | 退職者がいないか確認 |
| チーム招待コード | 必要時 | 漏洩時は再生成 |
| アクセスログ | 週1回 | Vercel Analytics |

### 5.2 メンバーの無効化

退職者や不要なメンバーを無効化:

1. `/members` にアクセス
2. 対象メンバーの「無効にする」をクリック

**効果**:
- 空き枠計算から除外
- ログインは引き続き可能（セッションがある場合）

### 5.3 招待コードの再生成

招待コードが漏洩した場合:

Supabase SQL Editor で実行:
```sql
UPDATE teams
SET invite_code = generate_invite_code()
WHERE id = 'your-team-id';
```

---

## 6. スケーリング

### 6.1 現在の制約

| リソース | 制限 | 備考 |
|---------|------|------|
| チームメンバー | 最大5名推奨 | API効率のため |
| 同時予約メニュー | 制限なし | - |
| 月間予約数 | 制限なし | - |

### 6.2 拡張が必要な場合

**メンバー数を増やす場合**:
- Google Calendar API のレート制限に注意
- 空き枠計算の所要時間が増加

**予約数が増える場合**:
- Supabase のプランアップグレードを検討
- Vercel の関数実行時間に注意

---

## 7. 障害対応

### 7.1 障害発生時のフロー

```
1. 障害検知
   ↓
2. メンテナンスモード有効化（必要に応じて）
   ↓
3. 原因調査
   - Vercel Dashboard でエラーログ確認
   - Supabase Dashboard でDB状態確認
   ↓
4. 復旧対応
   ↓
5. メンテナンスモード解除
   ↓
6. 事後報告
```

### 7.2 緊急連絡先

| サービス | ステータスページ |
|---------|-----------------|
| Vercel | https://www.vercel-status.com/ |
| Supabase | https://status.supabase.com/ |
| Google Cloud | https://status.cloud.google.com/ |

---

## 8. 運用チェックリスト

### 週次

- [ ] API利用量の確認
- [ ] エラーログの確認
- [ ] 予約状況の確認

### 月次

- [ ] メンバー一覧の確認（退職者チェック）
- [ ] 不要データの削除検討
- [ ] セキュリティアップデートの確認

### 四半期

- [ ] 依存パッケージの更新
- [ ] ドキュメントの見直し
- [ ] 運用フローの改善検討
