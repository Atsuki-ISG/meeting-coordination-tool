# 運用マニュアル

## 1. 日常運用

### 1.1 監視項目

| 項目 | 確認頻度 | 確認方法 |
|------|---------|---------|
| 承認待ちユーザー | 日次 | `/admin` 画面 |
| API利用量 | 週1回 | `/admin` 画面 |
| 予約状況 | 日次 | `/bookings` 画面 |
| エラーログ | 日次 | Cloud Run コンソール |
| メンバー状況 | 週1回 | `/settings/team` 画面 |

### 1.2 API利用量の目安

Google Calendar API の無料枠:
- **日次上限**: 1,000,000 クエリ/日
- **ユーザーあたり上限**: 10,000 クエリ/日

**想定利用量（5人チーム）**:
| 操作 | APIコール数 | 月間想定回数 | 月間コール数 |
|------|------------|------------|-------------|
| 空き枠確認 | 5回/日付 | 1,000 | 5,000 |
| 予約作成 | 6回 | 100 | 600 |
| キャンセル | 1回 | 20 | 20 |
| **合計** | | | **約5,600** |

→ 無料枠内で十分運用可能

### 1.3 レート制限の監視

本システムには以下のレート制限が実装されています:

| 制限種別 | 制限値 | 監視方法 |
|---------|--------|---------|
| 短期制限 | 10秒間に5リクエスト/IP | 自動（429エラー） |
| 月間制限 | USAGE_ALERT_THRESHOLD | `/admin` 画面 |

**月間使用量アラート**:
- 80%到達時: 警告表示
- 100%到達時: 予約機能一時停止

---

## 2. ユーザー承認管理

### 2.1 承認待ちユーザーの確認

1. `/admin` にアクセス（システム管理者権限が必要）
2. 「承認待ちユーザー」タブで一覧を確認
3. 各ユーザーの以下を確認:
   - 名前
   - メールアドレス
   - 登録日時

### 2.2 ユーザーの承認

1. 承認待ちユーザー一覧で対象ユーザーを見つける
2. 「承認」ボタンをクリック
3. ステータスが `pending` → `active` に変更される
4. ユーザーは自動的にチーム画面にリダイレクトされる（30秒ごとの自動チェック）

### 2.3 ユーザーの拒否

1. 承認待ちユーザー一覧で対象ユーザーを見つける
2. 「拒否」ボタンをクリック
3. ステータスが `pending` → `suspended` に変更される
4. ユーザーはログアウトされ、以降ログイン不可

### 2.4 ユーザーの停止/再有効化

**停止する場合**:
1. 「全ユーザー」タブで対象ユーザーを見つける
2. 「停止」ボタンをクリック
3. ステータスが `active` → `suspended` に変更

**再有効化する場合**:
1. 「全ユーザー」タブで対象ユーザーを見つける
2. 「有効化」ボタンをクリック
3. ステータスが `suspended` → `active` に変更

### 2.5 システム管理者の追加

**方法1: 環境変数で設定（推奨）**
```bash
SYSTEM_ADMIN_EMAILS=admin1@example.com,admin2@example.com
```
→ 該当メールアドレスでログインすると自動的にシステム管理者になる

**方法2: 管理画面から付与**
1. `/admin` → 「全ユーザー」タブ
2. 対象ユーザーの「管理者に昇格」ボタンをクリック

**方法3: SQLで直接設定**
```sql
UPDATE members
SET is_system_admin = true
WHERE email = 'new-admin@example.com';
```

---

## 3. メンテナンス

### 3.1 メンテナンスモードの有効化

予約受付を一時停止する場合：

1. `/admin` にアクセス
2. 「Stop Service」ボタンをクリック
3. 外部ユーザーの予約ページに停止メッセージが表示される

**影響範囲**:
- `/book/*` ページで予約不可
- 社内メンバーの管理機能は利用可能

### 3.2 メンテナンスモードの解除

1. `/admin` にアクセス
2. 「Enable Service」ボタンをクリック

---

## 4. トラブルシューティング

### 4.1 ログインできない

**症状**: Googleログインボタンを押してもエラーになる

**確認手順**:
1. Google Cloud Console でOAuthクライアントIDを確認
2. リダイレクトURIが正しいか確認
3. OAuth同意画面が「本番環境」になっているか確認

**解決策**:
- リダイレクトURIを追加: `https://your-domain.com/api/auth/callback`
- OAuth同意画面を本番公開

### 4.2 承認待ち状態から抜けられない

**症状**: 承認されたはずなのに承認待ち画面のまま

**確認手順**:
1. `/admin` でユーザーのステータスを確認
2. ステータスが `active` になっているか確認

**解決策**:
- ユーザーに手動でステータス確認ボタンを押してもらう
- ユーザーにログアウト → 再ログインを依頼
- SQLで直接ステータスを確認・修正:
```sql
SELECT email, status, is_system_admin FROM members WHERE email = 'user@example.com';
```

### 4.3 カレンダー連携ができない

**症状**: ログインはできるがカレンダーが連携されない

**確認手順**:
1. Google OAuth同意画面でスコープを確認
2. Calendar API が有効か確認

**解決策**:
- スコープに `calendar.readonly`, `calendar.events` を追加
- ユーザーに再ログインを依頼

### 4.4 空き枠が表示されない

**症状**: 予約ページで空き枠が出てこない

**確認手順**:
1. `/settings/team` で対象メンバーのカレンダー連携状態を確認
2. `/settings` で予約可能時間が設定されているか確認
3. メンバーに再ログインを依頼してカレンダーを再連携

**解決策**:
- メンバーを有効化
- 予約可能時間を設定
- メンバーに再ログインを依頼してカレンダーを再連携

### 4.5 予約が作成できない

**症状**: 予約ボタンを押してもエラーになる

**確認手順**:
1. `/admin` でメンテナンスモードを確認
2. `/admin` で月間使用量が上限に達していないか確認
3. ブラウザの開発者ツールでエラー内容を確認

**よくあるエラー**:
- `Selected time slot is no longer available`: 他の予約と競合
- `No members with calendar access`: メンバーのカレンダー連携切れ
- `429 Too Many Requests`: レート制限に達した

### 4.6 Google Meetリンクが生成されない

**症状**: 予約は作成されるがMeetリンクがない

**原因**: Googleカレンダーのイベント作成権限の問題

**解決策**:
- 主催者のGoogle Workspaceアカウント設定を確認
- 個人アカウントの場合、Meetの自動生成が制限される場合あり

---

## 5. データ管理

### 5.1 バックアップ

Supabaseの自動バックアップ:
- **頻度**: 日次
- **保持期間**: 7日間（無料プラン）

手動バックアップ:
1. Supabase Dashboard → Database → Backups
2. 「Create backup」をクリック

### 5.2 データ削除

**古い予約データの削除**:

Supabase SQL Editor で実行:
```sql
-- 1年以上前のキャンセル済み予約を削除
DELETE FROM bookings
WHERE status = 'canceled'
  AND canceled_at < NOW() - INTERVAL '1 year';
```

**APIログの削除**:
```sql
-- 3ヶ月以上前のログを削除
DELETE FROM api_usage_logs
WHERE created_at < NOW() - INTERVAL '3 months';
```

---

## 6. セキュリティ運用

### 6.1 定期的な確認項目

| 項目 | 頻度 | 確認方法 |
|------|------|---------|
| 承認待ちユーザー | 日次 | `/admin` |
| 全ユーザー一覧 | 月1回 | `/admin` → 退職者がいないか確認 |
| システム管理者一覧 | 月1回 | `/admin` → 不要な管理者がいないか |
| チーム招待コード | 必要時 | 漏洩時は再生成 |
| アクセスログ | 週1回 | Cloud Run ログ |

### 6.2 メンバーの無効化

退職者や不要なメンバーを無効化:

1. `/admin` → 「全ユーザー」タブ
2. 対象メンバーの「停止」をクリック

**効果**:
- 即座にログアウトされる
- 以降ログイン不可
- 空き枠計算から除外

### 6.3 招待コードの再生成

招待コードが漏洩した場合:

Supabase SQL Editor で実行:
```sql
UPDATE teams
SET invite_code = generate_invite_code()
WHERE id = 'your-team-id';
```

---

## 7. スケーリング

### 7.1 現在の制約

| リソース | 制限 | 備考 |
|---------|------|------|
| チームメンバー | 最大5名推奨 | API効率のため |
| 同時予約メニュー | 制限なし | - |
| 月間予約数 | 制限なし | - |
| 月間API使用量 | USAGE_ALERT_THRESHOLD | デフォルト800,000 |

### 7.2 拡張が必要な場合

**メンバー数を増やす場合**:
- Google Calendar API のレート制限に注意
- 空き枠計算の所要時間が増加

**予約数が増える場合**:
- Supabase のプランアップグレードを検討
- Cloud Run のインスタンス数を調整

---

## 8. 障害対応

### 8.1 障害発生時のフロー

```
1. 障害検知
   ↓
2. メンテナンスモード有効化（必要に応じて）
   ↓
3. 原因調査
   - Cloud Run コンソールでエラーログ確認
   - Supabase Dashboard でDB状態確認
   ↓
4. 復旧対応
   ↓
5. メンテナンスモード解除
   ↓
6. 事後報告
```

### 8.2 緊急連絡先

| サービス | ステータスページ |
|---------|-----------------|
| Cloud Run | https://status.cloud.google.com/ |
| Supabase | https://status.supabase.com/ |
| Google APIs | https://status.cloud.google.com/ |

---

## 9. 運用チェックリスト

### 日次

- [ ] 承認待ちユーザーの確認・対応
- [ ] 予約状況の確認

### 週次

- [ ] API利用量の確認
- [ ] エラーログの確認

### 月次

- [ ] 全ユーザー一覧の確認（退職者チェック）
- [ ] システム管理者一覧の確認
- [ ] 不要データの削除検討
- [ ] セキュリティアップデートの確認

### 四半期

- [ ] 依存パッケージの更新
- [ ] ドキュメントの見直し
- [ ] 運用フローの改善検討
